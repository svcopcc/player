<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 隨機播放清單</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 設定 Inter 字體和深色模式 -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark .bg-white {
            background-color: #2d3748;
        }
        .flex-wrap-container {
            flex-wrap: wrap;
        }
        .playlist-item.active {
            background-color: #3b82f6;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-100 transition-colors duration-500">

    <div class="container mx-auto px-4 py-8 max-w-4xl min-h-screen flex flex-col items-center justify-center">

        <h1 class="text-3xl sm:text-4xl font-bold mb-6 text-center text-white">
            YouTube 隨機播放清單
        </h1>

        <!-- 播放器容器 -->
        <div id="player" class="w-full aspect-video rounded-xl shadow-2xl overflow-hidden mb-8"></div>

        <!-- 影片資訊和控制項 -->
        <div class="w-full bg-white dark:bg-gray-700 p-6 rounded-xl shadow-xl space-y-4">
            
            <!-- 目前播放影片名稱 -->
            <div class="mb-4">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                    目前播放影片
                </h2>
                <div id="video-title" class="mt-1 text-sm text-gray-700 dark:text-gray-300">
                    載入中...
                </div>
            </div>

            <!-- 音量控制 -->
            <div class="space-y-2">
                <label for="volume-slider" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                    音量
                </label>
                <input type="range" id="volume-slider" min="0" max="100" value="15" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
            </div>

            <!-- 關鍵字加權排序區塊 -->
            <div class="space-y-4 pt-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                    關鍵字加權排序
                </h3>
                <!-- 關鍵字單選按鈕 -->
                <div class="flex items-center space-x-4 flex-wrap-container">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">關鍵字:</label>
                    <div class="flex space-x-2">
                        <input type="radio" id="keyword-none" name="keyword" value="">
                        <label for="keyword-none" class="text-sm text-gray-700 dark:text-gray-300">無</label>
                    </div>
                    <div class="flex space-x-2">
                        <input type="radio" id="keyword-fs" name="keyword" value="瘋神" checked>
                        <label for="keyword-fs" class="text-sm text-gray-700 dark:text-gray-300">瘋神</label>
                    </div>
                    <div class="flex space-x-2">
                        <input type="radio" id="keyword-jqj" name="keyword" value="嘉慶君">
                        <label for="keyword-jqj" class="text-sm text-gray-700 dark:text-gray-300">嘉慶君</label>
                    </div>
                    <div class="flex space-x-2">
                        <input type="radio" id="keyword-rose" name="keyword" value="玫瑰">
                        <label for="keyword-rose" class="text-sm text-gray-700 dark:text-gray-300">玫瑰</label>
                    </div>
                    <div class="flex space-x-2">
                        <input type="radio" id="keyword-genius" name="keyword" value="天才">
                        <label for="keyword-genius" class="text-sm text-gray-700 dark:text-gray-300">天才</label>
                    </div>
                </div>
                <!-- 加權比例單選按鈕 -->
                <div class="flex items-center space-x-4 flex-wrap-container">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">加權比例:</label>
                    <div class="flex space-x-2">
                        <input type="radio" id="weight-50" name="weight" value="0.5">
                        <label for="weight-50" class="text-sm text-gray-700 dark:text-gray-300">50%</label>
                    </div>
                    <div class="flex space-x-2">
                        <input type="radio" id="weight-80" name="weight" value="0.8">
                        <label for="weight-80" class="text-sm text-gray-700 dark:text-gray-300">80%</label>
                    </div>
                    <div class="flex space-x-2">
                        <input type="radio" id="weight-99" name="weight" value="0.99" checked>
                        <label for="weight-99" class="text-sm text-gray-700 dark:text-gray-300">99%</label>
                    </div>
                </div>
            </div>

            <!-- 控制按鈕 -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button id="prev-btn" class="flex-1 px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-lg shadow-lg transition duration-300">
                    上一部
                </button>
                <button id="next-btn" class="flex-1 px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-lg shadow-lg transition duration-300">
                    下一部
                </button>
                <button id="shuffle-btn" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                    重新隨機播放
                </button>
                <button id="mode-btn" class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded-lg shadow-lg transition duration-300 dark:bg-gray-500 dark:hover:bg-gray-600 dark:text-white">
                    切換模式
                </button>
            </div>
        </div>

        <!-- 隨機排序後清單 -->
        <div id="playlist-order-container" class="mt-8 w-full bg-white dark:bg-gray-700 p-6 rounded-xl shadow-xl">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">
                隨機排序後清單
            </h2>
            <div id="video-count" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">
                播放清單總數：載入中...
            </div>
            <ol id="playlist-order" class="list-decimal list-inside text-sm text-gray-700 dark:text-gray-300 space-y-1">
                <!-- 清單項目將由 JavaScript 動態生成 -->
            </ol>
        </div>
    </div>

    <!-- 載入 YouTube IFrame Player API -->
    <script>
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        const playlistId = 'PLBCWta9qwiTFbZUMF51mfgrNWirfksMAY';
        const volumeSlider = document.getElementById('volume-slider');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const modeBtn = document.getElementById('mode-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const videoTitleEl = document.getElementById('video-title');
        const playlistOrderEl = document.getElementById('playlist-order');
        const videoCountEl = document.getElementById('video-count');
        
        // 使用您的 API 金鑰
        const API_KEY = 'AIzaSyCFZr95Wi-abUjm3arHeluJY_H4jqcLp70';

        let originalPlaylist = [];
        let shuffledPlaylist = [];
        let currentVideoIndex = 0;

        // Fisher-Yates 洗牌演算法
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // 顯示播放清單順序，並在載入時顯示載入中
        function displayPlaylistOrder() {
            playlistOrderEl.innerHTML = ''; // 清空舊列表
            if (shuffledPlaylist.length === 0) {
                playlistOrderEl.innerHTML = '<li>清單正在載入中...</li>';
                return;
            }
            
            shuffledPlaylist.forEach((video, index) => {
                const li = document.createElement('li');
                li.setAttribute('data-index', index);
                li.textContent = `(${index + 1}) ${video.title}`;
                li.classList.add('playlist-item');
                playlistOrderEl.appendChild(li);
            });
            updateHighlightedVideo();
        }

        // 執行加權排序並開始播放
        async function weightedShuffleAndPlay() {
            if (!originalPlaylist.length) {
                await fetchFullPlaylist();
                return;
            }

            const selectedKeyword = document.querySelector('input[name="keyword"]:checked').value;
            const weight = parseFloat(document.querySelector('input[name="weight"]:checked').value);

            let priorityVideos = [];
            let nonPriorityVideos = [];
            
            originalPlaylist.forEach(video => {
                 if (video.title.includes(selectedKeyword) && selectedKeyword !== "") {
                     priorityVideos.push(video);
                 } else {
                     nonPriorityVideos.push(video);
                 }
            });
            
            shuffledPlaylist = [];
            
            // 進行加權洗牌
            const shuffledPriority = shuffleArray(priorityVideos);
            const shuffledNonPriority = shuffleArray(nonPriorityVideos);

            const totalVideos = originalPlaylist.length;
            
            for (let i = 0; i < totalVideos; i++) {
                const usePriority = Math.random() < weight;
                if (usePriority && shuffledPriority.length > 0) {
                    shuffledPlaylist.push(shuffledPriority.shift());
                } else if (shuffledNonPriority.length > 0) {
                    shuffledPlaylist.push(shuffledNonPriority.shift());
                } else if (shuffledPriority.length > 0) {
                     shuffledPlaylist.push(shuffledPriority.shift());
                } else if (shuffledNonPriority.length > 0) {
                    shuffledPlaylist.push(shuffledNonPriority.shift());
                }
            }
            
            currentVideoIndex = 0;
            displayPlaylistOrder();
            playCurrentVideo();
        }

        // 播放當前索引的影片
        function playCurrentVideo() {
            if (shuffledPlaylist.length === 0) {
                console.log("No videos in playlist to play.");
                return;
            }

            if (currentVideoIndex < shuffledPlaylist.length) {
                const videoId = shuffledPlaylist[currentVideoIndex].id;
                player.loadVideoById(videoId);
            } else {
                // 如果播放清單結束，自動重新洗牌並從頭開始
                weightedShuffleAndPlay();
            }
        }

        // 更新列表中的高亮影片
        function updateHighlightedVideo() {
            const listItems = playlistOrderEl.querySelectorAll('li');
            listItems.forEach((item, index) => {
                if (index === currentVideoIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // 處理「上一部」按鈕
        function playPrevVideo() {
            currentVideoIndex--;
            if (currentVideoIndex < 0) {
                currentVideoIndex = shuffledPlaylist.length - 1;
            }
            playCurrentVideo();
        }

        // 處理「下一部」按鈕
        function playNextVideo() {
            currentVideoIndex++;
            if (currentVideoIndex >= shuffledPlaylist.length) {
                currentVideoIndex = 0;
            }
            playCurrentVideo();
        }

        // 使用 YouTube Data API 獲取完整播放清單
        async function fetchFullPlaylist() {
            let nextPageToken = null;
            originalPlaylist = [];

            try {
                do {
                    const response = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${API_KEY}${nextPageToken ? `&pageToken=${nextPageToken}` : ''}`);
                    if (!response.ok) {
                        throw new Error(`API 請求失敗，狀態碼: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    data.items.forEach(item => {
                        originalPlaylist.push({
                            id: item.snippet.resourceId.videoId,
                            title: item.snippet.title
                        });
                    });

                    nextPageToken = data.nextPageToken;

                } while (nextPageToken);

                videoCountEl.textContent = `播放清單總數：${originalPlaylist.length} 部影片`;
                weightedShuffleAndPlay();

            } catch (error) {
                console.error('獲取播放清單時發生錯誤:', error);
                videoCountEl.textContent = `獲取播放清單失敗。請檢查 API 金鑰設定與網路連線。`;
                // 如果 API 失敗，退回到舊的播放器載入方式
                player.loadPlaylist({
                    listType: 'playlist',
                    list: playlistId
                });
            }
        }

        // 當 YouTube IFrame API 載入完成時呼叫此函數
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: {
                    listType: 'playlist',
                    list: playlistId,
                    autoplay: 1,
                    enablejsapi: 1,
                    rel: 0,
                    showinfo: 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }
        
        // 播放器準備就緒時的處理函數
        function onPlayerReady(event) {
            fetchFullPlaylist();
            
            player.setVolume(15);
            volumeSlider.value = 15;
            
            volumeSlider.addEventListener('input', (e) => {
                player.setVolume(e.target.value);
            });
        }
        
        // 播放器狀態改變時的處理函數
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                const videoData = player.getVideoData();
                videoTitleEl.textContent = videoData.title;
                const currentVideoId = player.getVideoData().video_id;
                const currentIndex = shuffledPlaylist.findIndex(video => video.id === currentVideoId);
                if (currentIndex !== -1) {
                    currentVideoIndex = currentIndex;
                    updateHighlightedVideo();
                }
            } else if (event.data === YT.PlayerState.ENDED) {
                currentVideoIndex++;
                playCurrentVideo();
            }
        }
        
        // 播放器發生錯誤時的處理函數
        function onPlayerError(event) {
            if (event.data === 101 || event.data === 150) {
                videoTitleEl.textContent = "這部影片受限，將自動跳過並播放下一首...";
                setTimeout(() => {
                    currentVideoIndex++;
                    playCurrentVideo();
                }, 2000);
            }
        }

        // 綁定按鈕事件
        shuffleBtn.addEventListener('click', weightedShuffleAndPlay);
        prevBtn.addEventListener('click', playPrevVideo);
        nextBtn.addEventListener('click', playNextVideo);
        modeBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
        });
    </script>

</body>
</html>


